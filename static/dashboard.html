<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard | Clause</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .gradient-bg {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .glass-effect {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .hover-lift {
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .hover-lift:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    }
    
    .pulse-glow {
      animation: pulse-glow 2s infinite;
    }
    
    @keyframes pulse-glow {
      0%, 100% { box-shadow: 0 0 20px rgba(102, 126, 234, 0.4); }
      50% { box-shadow: 0 0 30px rgba(102, 126, 234, 0.8); }
    }
    
    .typing-animation {
      border-right: 2px solid #667eea;
      animation: typing-cursor 1s infinite;
    }
    
    @keyframes typing-cursor {
      0%, 50% { border-color: transparent; }
      51%, 100% { border-color: #667eea; }
    }
    
    .sidebar-item {
      transition: all 0.3s ease;
      cursor: pointer;
    }
    
    .sidebar-item:hover {
      background: linear-gradient(90deg, #667eea20, transparent);
      border-left: 3px solid #667eea;
      padding-left: 1rem;
    }
    
    .result-card {
      background: linear-gradient(145deg, #ffffff, #f8f9ff);
      border: none;
      box-shadow: 0 8px 32px rgba(102, 126, 234, 0.1);
    }
    
    .risk-badge {
      font-size: 0.875rem;
      padding: 0.5rem 1rem;
      border-radius: 50px;
      font-weight: 600;
    }
    
    .risk-low { background: linear-gradient(135deg, #10b981, #34d399); color: white; }
    .risk-medium { background: linear-gradient(135deg, #f59e0b, #fbbf24); color: white; }
    .risk-high { background: linear-gradient(135deg, #ef4444, #f87171); color: white; }
    .risk-very-high { background: linear-gradient(135deg, #dc2626, #ef4444); color: white; }
    
    .loading-spinner {
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    /* Tab styles */
    .tab-button {
      transition: all 0.3s ease;
      border-radius: 0.75rem 0.75rem 0 0;
    }
    
    .tab-button.active {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
    }
    
    .tab-button:not(.active) {
      background: rgba(255, 255, 255, 0.1);
      color: #6b7280;
    }
    
    .tab-button:not(.active):hover {
      background: rgba(255, 255, 255, 0.2);
      color: #374151;
    }

    /* PDF Upload Zone */
    .pdf-upload-zone {
      border: 3px dashed #d1d5db;
      transition: all 0.3s ease;
      cursor: pointer;
    }
    
    .pdf-upload-zone:hover, .pdf-upload-zone.dragover {
      border-color: #667eea;
      background: rgba(102, 126, 234, 0.05);
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <!-- Header -->
  <header class="bg-white shadow-lg border-b border-gray-200">
    <div class="px-6 py-4">
      <div class="flex items-center justify-between">
        <!-- Logo & Brand -->
        <div class="flex items-center space-x-4">
          <div class="w-10 h-10 rounded-xl gradient-bg flex items-center justify-center">
            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
          </div>
          <div>
            <h1 class="text-2xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">
              Clause.ai
            </h1>
            <p class="text-xs text-gray-500">Legal Document Generator</p>
          </div>
        </div>

        <!-- User Profile -->
        <div class="flex items-center space-x-4">
          <div class="hidden sm:block text-right">
            <p id="user-name" class="text-sm font-semibold text-gray-800">Loading...</p>
            <p id="user-email" class="text-xs text-gray-500">Loading...</p>
          </div>
          <div class="w-12 h-12 rounded-full bg-gradient-to-r from-indigo-500 to-purple-600 flex items-center justify-center shadow-lg">
            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
            </svg>
          </div>
          <button id="logout" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white font-semibold rounded-lg transition duration-300 shadow-md hover:shadow-lg">
            <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
            </svg>
            Logout
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Layout -->
  <div class="flex h-[calc(100vh-88px)]">
    <!-- Sidebar -->
    <aside class="w-80 bg-white shadow-xl border-r border-gray-200 overflow-y-auto">
      <div class="p-6">
        <div class="flex items-center space-x-2 mb-6">
          <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          <h2 class="text-lg font-semibold text-gray-800">Recent Activity</h2>
        </div>
        
        <div class="space-y-3">
          <ul id="promptList" class="space-y-2">
            <!-- Sample prompts -->
            <li class="sidebar-item p-3 rounded-lg bg-gray-50 hover:bg-indigo-50 transition-all duration-300">
              <div class="text-sm font-medium text-gray-800">I want to make sure that if we give someone access to our software for free to test it, they can't sue us if something breaks, and also they shouldn't be able to copy our idea or give it to someone else. But if they improve it, we might want to use that too. Write this as a legal clause.</div>
              <div class="text-xs text-gray-500 mt-1">2 hours ago</div>
            </li>
            <li class="sidebar-item p-3 rounded-lg bg-gray-50 hover:bg-indigo-50 transition-all duration-300">
              <div class="text-sm font-medium text-gray-800">The client must pay the full amount on all invoices within 15 days of receiving them</div>
              <div class="text-xs text-gray-500 mt-1">1 day ago</div>
            </li>
            <li class="sidebar-item p-3 rounded-lg bg-gray-50 hover:bg-indigo-50 transition-all duration-300">
              <div class="text-sm font-medium text-gray-800">Both parties agree to keep any business secrets they share with each other completely private and not tell anyone else.</div>
              <div class="text-xs text-gray-500 mt-1">3 days ago</div>
            </li>
          </ul>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto bg-gray-50">
      <div class="p-8">
        <!-- Header Section -->
        <div class="mb-8">
          <h1 class="text-3xl font-bold text-gray-800 mb-2">AI Legal Assistant</h1>
          <p class="text-gray-600">Generate legal clauses or summarize PDF documents with AI assistance.</p>
        </div>

        <!-- Tab Navigation -->
        <div class="mb-6">
          <nav class="flex space-x-1">
            <button id="clauseTab" class="tab-button active px-6 py-3 font-semibold transition-all duration-300">
              <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
              </svg>
              Generate Clause
            </button>
            <button id="pdfTab" class="tab-button px-6 py-3 font-semibold transition-all duration-300">
              <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
              </svg>
              Contract Summarizer
            </button>
          </nav>
        </div>

        <!-- Clause Generation Tab Content -->
        <div id="clauseContent" class="tab-content">
          <!-- Input Section -->
          <div class="bg-white rounded-2xl shadow-xl p-6 mb-8 hover-lift">
            <div class="flex items-center space-x-3 mb-4">
              <div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center">
                <svg class="w-4 h-4 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
                </svg>
              </div>
              <h3 class="text-lg font-semibold text-gray-800">What type of clause do you need?</h3>
            </div>
            
            <div class="mb-4">
              <label for="prompt" class="block text-sm font-medium text-gray-700 mb-2">Describe your requirements:</label>
              <textarea 
                id="prompt" 
                rows="4" 
                class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 resize-none transition-all duration-300 typing-animation"
                placeholder="e.g., 'Create a confidentiality clause for a software development contract between a startup and a freelancer'"
              ></textarea>
            </div>

            <div class="flex space-x-3">
              <button id="evaluate" class="flex-1 px-6 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-semibold rounded-xl hover:from-indigo-700 hover:to-purple-700 transition-all duration-300 shadow-lg hover:shadow-xl pulse-glow">
                <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                </svg>
                Generate & Assess
              </button>
              <button id="regenerate" class="px-6 py-3 bg-gray-500 text-white font-semibold rounded-xl hover:bg-gray-600 transition-all duration-300 shadow-lg" style="display: none;">
                <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
                Regenerate
              </button>
            </div>
          </div>

          <!-- Results Section -->
          <div class="bg-white rounded-2xl shadow-xl p-6 mb-8">
            <div class="flex items-center space-x-3 mb-6">
              <div class="w-8 h-8 rounded-full bg-green-100 flex items-center justify-center">
                <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
              </div>
              <h3 class="text-lg font-semibold text-gray-800">Generated Results</h3>
            </div>

            <div id="results" class="min-h-[200px] flex items-center justify-center text-gray-500">
              <div class="text-center">
                <svg class="w-16 h-16 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                <p class="text-lg font-medium">Ready to generate your clause</p>
                <p class="text-sm">Enter your requirements above and click "Generate & Assess"</p>
              </div>
            </div>
          </div>
        </div>

        <!-- PDF Summarizer Tab Content -->
        <div id="pdfContent" class="tab-content hidden">
          <!-- PDF Upload Section -->
          <div class="bg-white rounded-2xl shadow-xl p-6 mb-8 hover-lift">
            <div class="flex items-center space-x-3 mb-4">
              <div class="w-8 h-8 rounded-full bg-purple-100 flex items-center justify-center">
                <svg class="w-4 h-4 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                </svg>
              </div>
              <h3 class="text-lg font-semibold text-gray-800">Upload PDF Document</h3>
            </div>
            
            <div id="pdfUploadZone" class="pdf-upload-zone rounded-xl p-8 text-center border-2 border-dashed mb-4">
              <input type="file" id="pdfFileInput" accept=".pdf" class="hidden">
              <svg class="w-12 h-12 mx-auto mb-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
              </svg>
              <h4 class="text-lg font-semibold text-gray-700 mb-2">Drop PDF file here or click to browse</h4>
              <p class="text-gray-500 text-sm">Supports PDF files up to 10MB</p>
            </div>

            <button id="summarizePdf" class="w-full px-6 py-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white font-semibold rounded-xl hover:from-purple-700 hover:to-pink-700 transition-all duration-300 shadow-lg hover:shadow-xl disabled:opacity-50 disabled:cursor-not-allowed">
              <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
              </svg>
              Generate Summary & Audio
            </button>
          </div>

          <!-- PDF Results Section -->
          <div class="bg-white rounded-2xl shadow-xl p-6">
            <div class="flex items-center space-x-3 mb-6">
              <div class="w-8 h-8 rounded-full bg-orange-100 flex items-center justify-center">
                <svg class="w-4 h-4 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
              </div>
              <h3 class="text-lg font-semibold text-gray-800">PDF Summary & Audio</h3>
            </div>

            <div id="pdfResults" class="min-h-[200px] flex items-center justify-center text-gray-500">
              <div class="text-center">
                <svg class="w-16 h-16 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                <p class="text-lg font-medium">Ready to summarize your PDF</p>
                <p class="text-sm">Upload a PDF document above to get started</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script type="module">
    // Import Firebase core and auth modules from CDN
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    // Your Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyDyt3r9AGcHkuvL37frfaKFzr9er18OGMI",
      authDomain: "clause-9d753.firebaseapp.com",
      projectId: "clause-9d753",
      storageBucket: "clause-9d753.firebasestorage.app",
      messagingSenderId: "490035572199",
      appId: "1:490035572199:web:531332d89e2a2e690ba142",
      measurementId: "G-DMWH6P65EW"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    // UI Elements
    const userNameEl = document.getElementById('user-name');
    const userEmailEl = document.getElementById('user-email');
    const logoutButton = document.getElementById("logout");

    // Tab elements
    const clauseTab = document.getElementById('clauseTab');
    const pdfTab = document.getElementById('pdfTab');
    const clauseContent = document.getElementById('clauseContent');
    const pdfContent = document.getElementById('pdfContent');

    // Clause generation elements
    const evaluateButton = document.getElementById("evaluate");
    const regenerateButton = document.getElementById("regenerate");
    const promptInput = document.getElementById("prompt");
    const resultsDiv = document.getElementById("results");
    const promptList = document.getElementById('promptList');

    // PDF elements
    const pdfUploadZone = document.getElementById('pdfUploadZone');
    const pdfFileInput = document.getElementById('pdfFileInput');
    const summarizePdfButton = document.getElementById('summarizePdf');
    const pdfResultsDiv = document.getElementById('pdfResults');

    let lastPrompt = '';

    // --- Tab Management ---
    function switchTab(activeTab) {
      // Remove active class from all tabs
      clauseTab.classList.remove('active');
      pdfTab.classList.remove('active');
      
      // Hide all content
      clauseContent.classList.add('hidden');
      pdfContent.classList.add('hidden');
      
      // Show active tab and content
      if (activeTab === 'clause') {
        clauseTab.classList.add('active');
        clauseContent.classList.remove('hidden');
      } else {
        pdfTab.classList.add('active');
        pdfContent.classList.remove('hidden');
      }
    }

    clauseTab.addEventListener('click', () => switchTab('clause'));
    pdfTab.addEventListener('click', () => switchTab('pdf'));

    // --- Authentication Logic ---
    logoutButton.addEventListener("click", async () => {
        try {
            await signOut(auth);
            window.location.href = "index.html";
        } catch (error) {
            console.error("Logout error:", error.message);
            alert("Logout failed: " + error.message);
        }
    });

    onAuthStateChanged(auth, (user) => {
        if (user) {
            const email = user.email;
            const displayName = user.displayName || email.split('@')[0];
            userNameEl.textContent = displayName;
            userEmailEl.textContent = email;
        } else {
            window.location.href = 'index.html';
        }
    });

    // --- Utility Functions ---
    function getRiskBadgeClass(risk) {
        switch(risk.toLowerCase()) {
            case 'low': return 'risk-low';
            case 'medium': return 'risk-medium';
            case 'high': return 'risk-high';
            case 'very high': return 'risk-very-high';
            default: return 'risk-medium';
        }
    }

    function showLoadingState() {
        resultsDiv.innerHTML = `
            <div class="flex items-center justify-center py-12">
                <div class="text-center">
                    <div class="w-12 h-12 mx-auto mb-4 loading-spinner">
                        <svg class="w-full h-full text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                    </div>
                    <p class="text-lg font-medium text-gray-700">Generating comprehensive legal analysis...</p>
                    <p class="text-sm text-gray-500 mt-2">Processing both internal knowledge base and web sources</p>
                </div>
            </div>
        `;
    }

    function showPdfLoadingState() {
        pdfResultsDiv.innerHTML = `
            <div class="flex items-center justify-center py-12">
                <div class="text-center">
                    <div class="w-12 h-12 mx-auto mb-4 loading-spinner">
                        <svg class="w-full h-full text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                    </div>
                    <p class="text-lg font-medium text-gray-700">Processing PDF and generating summary...</p>
                    <p class="text-sm text-gray-500 mt-2">This may take a few moments</p>
                </div>
            </div>
        `;
    }

    async function downloadPdf(clauseText) {
        try {
            const response = await fetch("http://127.0.0.1:8000/download_pdf", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ clause: clauseText }),
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || "PDF generation failed.");
            }

            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "generated_clause.pdf";
            document.body.appendChild(a);
            a.click();
            a.remove();
            window.URL.revokeObjectURL(url);

        } catch (error) {
            console.error("Download PDF error:", error);
            alert(`Error downloading PDF: ${error.message}`);
        }
    }

    // Updated function to use the combined endpoint
    async function getEvaluation(prompt) {
        showLoadingState();
        regenerateButton.style.display = "none";

        try {
            const user = auth.currentUser;
            if (!user) {
                resultsDiv.innerHTML = `
                    <div class="text-center py-12">
                        <p class="text-red-500 font-medium">Please log in to use this feature.</p>
                    </div>
                `;
                return;
            }
            const idToken = await user.getIdToken();

            // Using the new combined endpoint
            const response = await fetch("http://127.0.0.1:8000/generate-combined", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${idToken}`
                },
                body: JSON.stringify({ prompt })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || "An unknown error occurred.");
            }

            const data = await response.json();
            const riskClass = getRiskBadgeClass(data.risk);
            
            resultsDiv.innerHTML = `
                <div class="result-card rounded-xl p-6">
                    <!-- RAG-based Results Section -->
                    <div class="mb-8">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="text-lg font-semibold text-gray-800 flex items-center">
                                <svg class="w-5 h-5 mr-2 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                                </svg>
                                Internal Knowledge Base - Generated Clause
                            </h4>
                            <span class="risk-badge ${riskClass}">${data.risk} Risk</span>
                        </div>
                        <div class="bg-gradient-to-r from-indigo-50 to-blue-50 rounded-lg p-4 border-l-4 border-indigo-500 mb-4">
                            <p class="text-gray-800 leading-relaxed">${data.rag_clause.replace(/\*/g, '')}</p>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div class="bg-blue-50 rounded-lg p-4">
                                <h5 class="font-semibold text-blue-800 mb-2">Classification</h5>
                                <p class="text-blue-700">${data.classification}</p>
                            </div>
                            <div class="bg-purple-50 rounded-lg p-4">
                                <h5 class="font-semibold text-purple-800 mb-2">Source</h5>
                                <p class="text-purple-700">${data.rag_source}</p>
                            </div>
                        </div>
                        
                        <button id="download-rag-btn" class="px-6 py-2 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition duration-300 shadow-md hover:shadow-lg">
                            <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            Download Internal KB Clause as PDF
                        </button>
                    </div>

                    <!-- Divider -->
                    <div class="border-t border-gray-200 my-8"></div>

                    <!-- Web Search Results Section -->
                    <div class="mb-6">
                        <div class="flex items-center mb-4">
                            <h4 class="text-lg font-semibold text-gray-800 flex items-center">
                                <svg class="w-5 h-5 mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 0L9 8l4-4 4 4"></path>
                                </svg>
                                Web Research - Alternative Perspective
                            </h4>
                        </div>
                        <div class="bg-gradient-to-r from-green-50 to-teal-50 rounded-lg p-4 border-l-4 border-green-500 mb-4">
                            <p class="text-gray-800 leading-relaxed">${data.web_text.replace(/\*/g, '')}</p>
                        </div>
                        
                        <div class="flex items-center justify-between">
                            <div class="flex space-x-3">
                                <button id="download-web-btn" class="px-6 py-2 bg-teal-600 hover:bg-teal-700 text-white font-semibold rounded-lg transition duration-300 shadow-md hover:shadow-lg">
                                    <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                    Download Web Research as PDF
                                </button>
                                ${data.web_source_link !== '#' ? `
                                <a href="${data.web_source_link}" target="_blank" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition duration-300 shadow-md hover:shadow-lg inline-flex items-center">
                                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                                    </svg>
                                    View Source
                                </a>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            regenerateButton.style.display = "inline-block";

            // Add to sidebar
            const li = document.createElement('li');
            li.className = 'sidebar-item p-3 rounded-lg bg-gray-50 hover:bg-indigo-50 transition-all duration-300';
            li.innerHTML = `
                <div class="text-sm font-medium text-gray-800">${prompt.substring(0, 50)}${prompt.length > 50 ? '...' : ''}</div>
                <div class="text-xs text-gray-500 mt-1">Just now</div>
            `;
            promptList.prepend(li);

            // Add event listeners for download buttons
            document.getElementById('download-rag-btn').addEventListener('click', (event) => {
                event.preventDefault();
                downloadPdf(data.rag_clause);
            });

            document.getElementById('download-web-btn').addEventListener('click', (event) => {
                event.preventDefault();
                downloadPdf(data.web_text);
            });

        } catch (error) {
            console.error("Evaluation error:", error);
            resultsDiv.innerHTML = `
                <div class="text-center py-12">
                    <div class="w-16 h-16 mx-auto mb-4 bg-red-100 rounded-full flex items-center justify-center">
                        <svg class="w-8 h-8 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <p class="text-red-500 font-medium text-lg">Error occurred</p>
                    <p class="text-gray-600 mt-2">${error.message}</p>
                </div>
            `;
        }
    }

    // --- PDF Summarizer Functions ---
    async function processPdf(file) {
        if (!file) {
            alert("Please select a PDF file first.");
            return;
        }

        if (file.type !== 'application/pdf') {
            alert("Please select a valid PDF file.");
            return;
        }

        showPdfLoadingState();
        summarizePdfButton.disabled = true;
        const originalButtonText = summarizePdfButton.innerHTML;
        summarizePdfButton.innerHTML = `
            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Processing PDF...
        `;

        try {
            const formData = new FormData();
            formData.append('file', file);

            const response = await fetch("http://127.0.0.1:8000/upload-pdf/", {
                method: "POST",
                body: formData,
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || "PDF processing failed.");
            }

            const data = await response.json();
            
            pdfResultsDiv.innerHTML = `
                <div class="result-card rounded-xl p-6">
                    <div class="mb-6">
                        <h4 class="text-lg font-semibold text-gray-800 mb-4">ðŸ“„ Document Summary</h4>
                        <div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg p-6 border-l-4 border-purple-500">
                            <p class="text-gray-800 leading-relaxed text-base">${data.summary}</p>
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <h5 class="text-lg font-semibold text-gray-800 mb-4">ðŸŽ§ Listen to Summary</h5>
                        <div class="bg-gradient-to-r from-indigo-50 to-blue-50 rounded-lg p-4">
                            <audio id="summaryAudio" controls class="w-full">
                                <source src="/temp/${data.audio_filename}" type="audio/mpeg">
                                Your browser does not support the audio element.
                            </audio>
                        </div>
                    </div>

                    <div class="flex items-center justify-between p-4 bg-green-50 rounded-lg">
                        <div class="flex items-center space-x-2">
                            <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                            <span class="text-green-700 font-medium">PDF processed successfully!</span>
                        </div>
                        <span class="text-green-600 text-sm">Status: ${data.status}</span>
                    </div>
                </div>
            `;

            // Add to sidebar
            const li = document.createElement('li');
            li.className = 'sidebar-item p-3 rounded-lg bg-gray-50 hover:bg-indigo-50 transition-all duration-300';
            li.innerHTML = `
                <div class="text-sm font-medium text-gray-800">PDF Summary: ${file.name.substring(0, 30)}${file.name.length > 30 ? '...' : ''}</div>
                <div class="text-xs text-gray-500 mt-1">Just now</div>
            `;
            promptList.prepend(li);

        } catch (error) {
            console.error("PDF processing error:", error);
            pdfResultsDiv.innerHTML = `
                <div class="text-center py-12">
                    <div class="w-16 h-16 mx-auto mb-4 bg-red-100 rounded-full flex items-center justify-center">
                        <svg class="w-8 h-8 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <p class="text-red-500 font-medium text-lg">PDF Processing Failed</p>
                    <p class="text-gray-600 mt-2">${error.message}</p>
                </div>
            `;
        } finally {
            summarizePdfButton.disabled = false;
            summarizePdfButton.innerHTML = originalButtonText;
        }
    }

    // --- Event Listeners ---

    // Clause Generation
    evaluateButton.addEventListener("click", async () => {
        const prompt = promptInput.value.trim();
        if (!prompt) {
            alert("Please enter your requirements first.");
            return;
        }
        lastPrompt = prompt;
        getEvaluation(prompt);
    });

    regenerateButton.addEventListener("click", async () => {
        if (lastPrompt) {
            getEvaluation(lastPrompt);
        } else {
            resultsDiv.innerHTML = `
                <div class="text-center py-12">
                    <p class="text-orange-500 font-medium">No previous prompt to regenerate.</p>
                </div>
            `;
        }
    });

    promptInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && e.ctrlKey) {
            evaluateButton.click();
        }
    });

    // PDF Upload and Processing
    pdfUploadZone.addEventListener('click', () => pdfFileInput.click());
    
    pdfUploadZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        pdfUploadZone.classList.add('dragover');
    });
    
    pdfUploadZone.addEventListener('dragleave', () => {
        pdfUploadZone.classList.remove('dragover');
    });
    
    pdfUploadZone.addEventListener('drop', (e) => {
        e.preventDefault();
        pdfUploadZone.classList.remove('dragover');
        if (e.dataTransfer.files.length > 0) {
            pdfFileInput.files = e.dataTransfer.files;
            updateUploadZoneText(e.dataTransfer.files[0]);
        }
    });

    pdfFileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            updateUploadZoneText(e.target.files[0]);
        }
    });

    function updateUploadZoneText(file) {
        if (file) {
            pdfUploadZone.innerHTML = `
                <svg class="w-12 h-12 mx-auto mb-4 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                <h4 class="text-lg font-semibold text-gray-700 mb-2">ðŸ“„ ${file.name}</h4>
                <p class="text-gray-500 text-sm">File size: ${(file.size / (1024 * 1024)).toFixed(2)} MB</p>
                <p class="text-purple-600 text-sm mt-2">Click "Generate Summary & Audio" to process</p>
            `;
        }
    }

    summarizePdfButton.addEventListener('click', () => {
        const file = pdfFileInput.files[0];
        processPdf(file);
    });

  </script>
</body>
</html>